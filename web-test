#!/usr/bin/env node

import { program } from 'commander';
import TestRunner from './src/test-runner.js';
import ConfigManager from './src/config-manager.js';
import TestCaseGenerator from './src/test-case-generator.js';
import TestCaseManager from './src/test-case-manager.js';
import TestCaseAutoGenerator from './src/test-case-auto-generator.js';

program
  .name('web-test')
  .description('WebTestAI - AI-Powered Web Testing Framework')
  .version('1.0.0');

program
  .command('run')
  .description('ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ')
  .option('--cli <type>', 'AI CLIé¸æŠ (gemini|claude|auto)', 'auto')
  .option('--target <name>', 'ãƒ†ã‚¹ãƒˆå¯¾è±¡å')
  .option('--cases <ids>', 'ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹IDï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰')
  .option('--category <name>', 'ãƒ†ã‚¹ãƒˆã‚«ãƒ†ã‚´ãƒª')
  .option('--screenshot <on|off>', 'ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ', 'on')
  .option('--format <type>', 'å‡ºåŠ›å½¢å¼ (csv|excel|html)', 'excel')
  .option('--parallel <num>', 'ä¸¦åˆ—å®Ÿè¡Œæ•°', '1')
  .option('-v, --verbose', 'è©³ç´°ãƒ­ã‚°')
  .action(async (options) => {
    const runner = new TestRunner(options);
    await runner.execute();
  });

program
  .command('switch <cli>')
  .description('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆAI CLIåˆ‡ã‚Šæ›¿ãˆ')
  .action(async (cli) => {
    const config = new ConfigManager();
    await config.switchDefaultCli(cli);
  });

program
  .command('config')
  .description('è¨­å®šç”»é¢è¡¨ç¤º')
  .action(async () => {
    const config = new ConfigManager();
    await config.showConfigUI();
  });

program
  .command('generate')
  .description('Playwrightã§ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹è‡ªå‹•ç”Ÿæˆ')
  .option('--url <url>', 'å¯¾è±¡URLæŒ‡å®š')
  .option('--name <name>', 'ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹å')
  .option('--edit <test_id>', 'æ—¢å­˜ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ç·¨é›†')
  .option('--headless <true|false>', 'ãƒ˜ãƒƒãƒ‰ãƒ¬ã‚¹ãƒ¢ãƒ¼ãƒ‰', 'false')
  .action(async (options) => {
    const generator = new TestCaseGenerator(options);
    await generator.startRecording();
  });

program
  .command('cases')
  .description('ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ç®¡ç†')
  .option('--list', 'ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä¸€è¦§è¡¨ç¤º')
  .option('--delete <test_id>', 'ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹å‰Šé™¤')
  .action(async (options) => {
    const manager = new TestCaseManager();
    
    if (options.list) {
      await manager.listTestCases();
    } else if (options.delete) {
      await manager.deleteTestCase(options.delete);
    } else {
      await manager.showUI();
    }
  });

program
  .command('auto-generate')
  .alias('auto')
  .description('AIã§ãƒšãƒ¼ã‚¸ã‚’è§£æã—ã¦ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’è‡ªå‹•ç”Ÿæˆ')
  .option('--url <url>', 'è§£æã™ã‚‹ãƒšãƒ¼ã‚¸ã®URL')
  .option('--headless', 'ãƒ˜ãƒƒãƒ‰ãƒ¬ã‚¹ãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œ')
  .option('--cli <type>', 'AI CLIé¸æŠ (gemini|claude|auto)', 'auto')
  .action(async (options) => {
    const autoGenerator = new TestCaseAutoGenerator(options);
    if (options.url) {
      // URLæŒ‡å®šã®å ´åˆã¯ç›´æ¥è§£æ
      const analysis = await autoGenerator.analyzePageWithAI(options.url);
      console.log(`\nâœ… ${analysis.testSuggestions.length}å€‹ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’ç”Ÿæˆã—ã¾ã—ãŸ`);
      
      // è‡ªå‹•ä¿å­˜
      const saved = await autoGenerator.saveGeneratedTestCases(analysis.testSuggestions);
      console.log(`ğŸ“ ä¿å­˜å®Œäº†: ${saved.map(tc => tc.test_id).join(', ')}`);
    } else {
      // å¯¾è©±å¼ãƒ¢ãƒ¼ãƒ‰
      await autoGenerator.interactiveAutoGenerate();
    }
  });

program.parse();
