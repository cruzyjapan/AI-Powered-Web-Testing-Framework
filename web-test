#!/usr/bin/env node

import { program } from 'commander';
import TestRunner from './src/test-runner.js';
import ConfigManager from './src/config-manager.js';
import TestCaseGenerator from './src/test-case-generator.js';
import TestCaseManager from './src/test-case-manager.js';
import TestCaseAutoGenerator from './src/test-case-auto-generator.js';
import TestCaseRecorder from './src/test-case-recorder.js';
import TestCaseOptimizer from './src/test-case-optimizer.js';

program
  .name('web-test')
  .description('WebTestAI - AIé§†å‹•å‹Webãƒ†ã‚¹ãƒˆè‡ªå‹•åŒ–ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ v2.3.2 - Powered By Yoshimasa Yamamoto \n\nä¸»ãªæ©Ÿèƒ½:\n  ğŸ¤– AIè‡ªå‹•ãƒ†ã‚¹ãƒˆç”Ÿæˆ - URLã‹ã‚‰æœ€å¤§50å€‹ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’è‡ªå‹•ç”Ÿæˆ\n  âœ¨ ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹æœ€é©åŒ– - é‡è¤‡å‰Šé™¤ã¨ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿è‡ªå‹•æ”¹å–„\n  ğŸŒ ãƒãƒ«ãƒãƒ–ãƒ©ã‚¦ã‚¶å¯¾å¿œ - Chromium/Firefox/WebKitã§å®Ÿè¡Œå¯èƒ½\n  ğŸ›’ EC-CUBE 4.2å¯¾å¿œ - EC-CUBEã‚µã‚¤ãƒˆã®è‡ªå‹•æ¤œå‡ºã¨å°‚ç”¨è§£æï¼ˆãƒ•ãƒ­ãƒ³ãƒˆå°‚ç”¨ãƒ•ã‚£ãƒ«ã‚¿ï¼‰\n  ğŸ‘ï¸ å¯è¦–è¦ç´ è§£æ - ç”»é¢è¡¨ç¤ºè¦ç´ ã‚’åº§æ¨™é †ã§å®Œå…¨è§£æ\n  ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆå¼·åŒ– - XSS/SQLã‚’1ã‚±ãƒ¼ã‚¹å†…ã§ã€Œå…¥åŠ›â†’é€ä¿¡â†’æœªç™ºç«ç¢ºèªã€ã¾ã§å®Ÿè¡Œ\n  âš™ï¸ å®‰å®šã‚¯ãƒªãƒƒã‚¯(safeClick) - ã‚µãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼/ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚‚ç¢ºå®Ÿã«ã‚¯ãƒªãƒƒã‚¯ãƒ»é·ç§»\n  ğŸ§  å…¥åŠ›ãƒ‡ãƒ¼ã‚¿æ¨è«– - placeholder/å‰å¾Œæ–‡è„ˆã‹ã‚‰ãƒ€ãƒŸãƒ¼å€¤ã‚’è‡ªå‹•ç”Ÿæˆï¼ˆCLIãŒã‚ã‚Œã°AIï¼‰\n  ğŸ¬ æ“ä½œéŒ²ç”»ãƒ»å†ç”Ÿ - ãƒ–ãƒ©ã‚¦ã‚¶æ“ä½œã‚’éŒ²ç”»ã—ã¦ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹åŒ–\n  ğŸ‡¯ğŸ‡µ æ—¥æœ¬æ™‚é–“å¯¾å¿œ - ã™ã¹ã¦ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’JSTã§è¨˜éŒ²\n\nã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ:\n  ./web-test auto              # å¯¾è©±å‹ã§ãƒ†ã‚¹ãƒˆè‡ªå‹•ç”Ÿæˆï¼ˆæ¨å¥¨ï¼‰\n  ./web-test auto --browser firefox  # Firefoxã§ç”Ÿæˆ\n  ./web-test optimize --mode auto --auto-save  # ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹æœ€é©åŒ–\n  ./web-test record            # ãƒ–ãƒ©ã‚¦ã‚¶æ“ä½œã‚’éŒ²ç”»\n  ./web-test run               # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå¯èƒ½ï¼‰\n  ./web-test run --browser all # å…¨ãƒ–ãƒ©ã‚¦ã‚¶ã§å®Ÿè¡Œ\n  ./web-test help              # è©³ç´°ãªãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º\n\nè©³ç´°: README.md ã¾ãŸã¯ https://github.com/your-repo/WebTestAI')
  .version('2.3.2');

program
  .command('run')
  .description('ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’å®Ÿè¡Œã—ã¾ã™\n\nä½¿ç”¨ä¾‹:\n  ./web-test run                      # ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã—ã¦å®Ÿè¡Œ\n  ./web-test run --cases TC001,TC002  # ç‰¹å®šãƒ†ã‚¹ãƒˆã®ã¿å®Ÿè¡Œ\n  ./web-test run --browser firefox    # Firefoxã§å®Ÿè¡Œ\n  ./web-test run --browser all        # å…¨ãƒ–ãƒ©ã‚¦ã‚¶ã§å®Ÿè¡Œ\n  ./web-test run --test-file test.json # ç‰¹å®šãƒ•ã‚¡ã‚¤ãƒ«æŒ‡å®š\n  ./web-test run --no-prompt          # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§å³å®Ÿè¡Œ\n  ./web-test run --cli gemini         # Gemini CLIä½¿ç”¨')
  .option('--cli <type>', 'AI CLIé¸æŠ (gemini|claude|auto)', 'auto')
  .option('--browser <type>', 'ãƒ–ãƒ©ã‚¦ã‚¶é¸æŠ (chromium|firefox|webkit|all)', 'chromium')
  .option('--target <name>', 'ãƒ†ã‚¹ãƒˆå¯¾è±¡å')
  .option('--cases <ids>', 'ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹IDï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰')
  .option('--category <name>', 'ãƒ†ã‚¹ãƒˆã‚«ãƒ†ã‚´ãƒª')
  .option('--screenshot <on|off>', 'ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ', 'on')
  .option('--format <type>', 'å‡ºåŠ›å½¢å¼ (csv|excel|html)', 'excel')
  .option('--parallel <num>', 'ä¸¦åˆ—å®Ÿè¡Œæ•°', '1')
  .option('--test-file <filename>', 'ä½¿ç”¨ã™ã‚‹ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«')
  .option('--no-prompt', 'ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ä½¿ç”¨ï¼‰')
  .option('-v, --verbose', 'è©³ç´°ãƒ­ã‚°')
  .action(async (options) => {
    const runner = new TestRunner(options);
    await runner.execute();
  });

program
  .command('switch [cli]')
  .description('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆAI CLIã‚’åˆ‡ã‚Šæ›¿ãˆã¾ã™\n\nä½¿ç”¨ä¾‹:\n  ./web-test switch          # åˆ©ç”¨å¯èƒ½ãªCLIä¸€è¦§ã‚’è¡¨ç¤º\n  ./web-test switch gemini   # Gemini CLIã«åˆ‡ã‚Šæ›¿ãˆ\n  ./web-test switch claude   # Claude Code CLIã«åˆ‡ã‚Šæ›¿ãˆ\n  ./web-test switch auto     # è‡ªå‹•é¸æŠãƒ¢ãƒ¼ãƒ‰')
  .action(async (cli) => {
    const config = new ConfigManager();
    await config.switchDefaultCli(cli);
  });

program
  .command('config')
  .description('è¨­å®šç”»é¢è¡¨ç¤º')
  .action(async () => {
    const config = new ConfigManager();
    await config.showConfigUI();
  });

program
  .command('generate')
  .description('Playwrightã§ãƒ–ãƒ©ã‚¦ã‚¶æ“ä½œã‚’éŒ²ç”»ã—ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’ç”Ÿæˆ\n\næ–°ãƒ­ã‚¸ãƒƒã‚¯:\n  â€¢ ã‚¯ãƒªãƒƒã‚¯ã¯safeClickã‚’ä½¿ç”¨ï¼ˆã‚µãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼/ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼/ç¥–å…ˆãƒ»å­å­«aç­‰ã‚’è‡ªå‹•è£œå®Œï¼‰\n  â€¢ ã‚¹ãƒ†ãƒƒãƒ—ã¯ä¸è¶³æ™‚ã«åˆæˆï¼ˆã‚¢ã‚¯ã‚»ã‚¹â†’æ“ä½œâ†’é·ç§»å¾…æ©Ÿï¼‰\n\nä½¿ç”¨ä¾‹:\n  ./web-test generate                        # å¯¾è©±å¼ã§éŒ²ç”»\n  ./web-test generate --url https://example.com  # URLæŒ‡å®š\n  ./web-test generate --edit TC001           # æ—¢å­˜ç·¨é›†')
  .option('--url <url>', 'å¯¾è±¡URLæŒ‡å®š')
  .option('--name <name>', 'ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹å')
  .option('--browser <type>', 'ãƒ–ãƒ©ã‚¦ã‚¶é¸æŠ (chromium|firefox|webkit)', 'chromium')
  .option('--edit <test_id>', 'æ—¢å­˜ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ç·¨é›†')
  .option('--headless <true|false>', 'ãƒ˜ãƒƒãƒ‰ãƒ¬ã‚¹ãƒ¢ãƒ¼ãƒ‰', 'false')
  .action(async (options) => {
    const generator = new TestCaseGenerator(options);
    await generator.startRecording();
  });

program
  .command('record')
  .alias('rec')
  .description('ãƒ–ãƒ©ã‚¦ã‚¶æ“ä½œã‚’éŒ²ç”»ã—ã¦ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’ä½œæˆ\n\nä½¿ç”¨ä¾‹:\n  ./web-test record                     # å¯¾è©±å¼ã§URLå…¥åŠ›\n  ./web-test record --url https://example.com  # URLæŒ‡å®šã§éŒ²ç”»\n  ./web-test rec                        # ã‚¨ã‚¤ãƒªã‚¢ã‚¹ä½¿ç”¨\n\néŒ²ç”»æ“ä½œ:\n  - ã‚¯ãƒªãƒƒã‚¯ã€å…¥åŠ›ã€ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãªã©ã™ã¹ã¦ã®æ“ä½œã‚’è¨˜éŒ²\n  - éŒ²ç”»çµ‚äº†: ãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‰ã˜ã‚‹ã‹Ctrl+C\n  - éŒ²ç”»ãƒ‡ãƒ¼ã‚¿ã¯ recordings/ ã«ä¿å­˜')
  .option('--url <url>', 'éŒ²ç”»ã‚’é–‹å§‹ã™ã‚‹URL')
  .option('--browser <type>', 'ãƒ–ãƒ©ã‚¦ã‚¶é¸æŠ (chromium|firefox|webkit)', 'chromium')
  .option('--video', 'ãƒ“ãƒ‡ã‚ªéŒ²ç”»ã‚’æœ‰åŠ¹åŒ–', true)
  .action(async (options) => {
    const { default: TestCaseRecorder } = await import('./src/test-case-recorder.js');
    const recorder = new TestCaseRecorder(options);
    
    let url = options.url;
    if (!url) {
      const { default: inquirer } = await import('inquirer');
      const answer = await inquirer.prompt([{
        type: 'input',
        name: 'url',
        message: 'éŒ²ç”»ã‚’é–‹å§‹ã™ã‚‹URL:',
        default: 'http://localhost:3000'
      }]);
      url = answer.url;
    }
    
    await recorder.startRecording(url);
  });

program
  .command('cases')
  .description('ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’ç®¡ç†ã—ã¾ã™\n\nä½¿ç”¨ä¾‹:\n  ./web-test cases             # å¯¾è©±å¼UIè¡¨ç¤º\n  ./web-test cases --list      # ä¸€è¦§è¡¨ç¤º\n  ./web-test cases --delete TC001  # å‰Šé™¤\n  ./web-test cases --export    # ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ')
  .option('--list', 'ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä¸€è¦§è¡¨ç¤º')
  .option('--delete <test_id>', 'ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹å‰Šé™¤')
  .option('--export', 'ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ')
  .action(async (options) => {
    const manager = new TestCaseManager();
    
    if (options.list) {
      await manager.listTestCases();
    } else if (options.delete) {
      await manager.deleteTestCase(options.delete);
    } else if (options.export) {
      await manager.exportTestCases();
    } else {
      await manager.showUI();
    }
  });

program
  .command('export')
  .description('ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ\n\nä½¿ç”¨ä¾‹:\n  ./web-test export                     # CSVå½¢å¼ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰\n  ./web-test export --format json       # JSONå½¢å¼\n  ./web-test export --format markdown   # Markdownå½¢å¼\n  ./web-test export --encoding utf8     # UTF-8ã§å‡ºåŠ›')
  .option('--format <type>', 'ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå½¢å¼ (json|csv|markdown)', 'csv')
  .option('--encoding <type>', 'ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° (shift_jis|utf8|utf8_bom)', 'shift_jis')
  .action(async (options) => {
    const manager = new TestCaseManager();
    await manager.exportTestCasesWithOptions(options);
  });

program
  .command('play')
  .alias('replay')
  .description('éŒ²ç”»ã—ãŸãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’å†ç”Ÿã—ã¾ã™\n\nä½¿ç”¨ä¾‹:\n  ./web-test play --list                 # éŒ²ç”»ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§\n  ./web-test play --file test.json       # ç‰¹å®šãƒ•ã‚¡ã‚¤ãƒ«å†ç”Ÿ\n  ./web-test play --file test.json --speed 2     # 2å€é€Ÿ\n  ./web-test play --file test.json --headless    # ãƒ˜ãƒƒãƒ‰ãƒ¬ã‚¹\n  ./web-test play --file test.json --auto-generate  # ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹è‡ªå‹•ç”Ÿæˆ\n\næ³¨æ„: JSONãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿å¯¾å¿œï¼ˆ.webmå‹•ç”»ã¯ä¸å¯ï¼‰')
  .option('--list', 'éŒ²ç”»æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’è¡¨ç¤º')
  .option('--file <filename>', 'å†ç”Ÿã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®š')
  .option('--speed <speed>', 'å†ç”Ÿé€Ÿåº¦ (0.5-5)', '1')
  .option('--headless', 'ãƒ˜ãƒƒãƒ‰ãƒ¬ã‚¹ãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œ')
  .option('--no-generate', 'ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ç”Ÿæˆã‚’ã‚¹ã‚­ãƒƒãƒ—')
  .option('--auto-generate', 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã§è‡ªå‹•çš„ã«ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ç”Ÿæˆ')
  .action(async (options) => {
    const recorder = new TestCaseRecorder();
    
    if (options.list) {
      await recorder.listRecordings();
    } else if (options.file) {
      await recorder.playRecording(options.file, {
        speed: parseFloat(options.speed),
        headless: options.headless,
        noGenerate: !options.generate,
        autoGenerate: options.autoGenerate
      });
    } else {
      // å¯¾è©±å¼é¸æŠ
      await recorder.interactivePlayback();
    }
  });

program
  .command('auto-generate')
  .alias('auto')
  .description('AIã§ãƒšãƒ¼ã‚¸ã‚’è§£æã—ã¦ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’è‡ªå‹•ç”Ÿæˆ\n\næ–°ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆ2025-09ï¼‰:\n  â€¢ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: XSS/SQLã¯å˜ä¸€ã‚±ãƒ¼ã‚¹å†…ã§ã€Œå…¥åŠ›â†’é€ä¿¡â†’æœªç™ºç«ç¢ºèªã€ã¾ã§å®Ÿè¡Œ\n  â€¢ å…¥åŠ›å€¤æ¨è«–: placeholder/å‰å¾Œæ–‡è„ˆã‹ã‚‰ãƒ€ãƒŸãƒ¼å€¤ã‚’ç”Ÿæˆï¼ˆCLI/ãƒ«ãƒ¼ãƒ«ï¼‰\n  â€¢ ã‚¹ãƒ†ãƒƒãƒ—è£œå®Œ: ãƒªãƒ³ã‚¯/ã‚»ãƒ¬ã‚¯ãƒˆ/æ¤œç´¢ã¯ä¸è¶³æ™‚ã«åˆæˆï¼ˆã‚¢ã‚¯ã‚»ã‚¹â†’æ“ä½œâ†’é·ç§»å¾…æ©Ÿï¼‰\n  â€¢ safeClick: ã‚µãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ»ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚‚ç¢ºå®Ÿã«ã‚¯ãƒªãƒƒã‚¯\n\nä½¿ç”¨ä¾‹:\n  ./web-test auto                    # å¯¾è©±å¼ï¼ˆBase/Admin/ã‚«ã‚¹ã‚¿ãƒ URLé¸æŠï¼‰\n  ./web-test auto --url https://example.com  # URLç›´æ¥æŒ‡å®š\n  ./web-test auto --browser firefox  # Firefoxã§è§£æ\n  ./web-test auto --cli gemini       # Gemini CLIä½¿ç”¨\n  ./web-test auto --headless         # ãƒ˜ãƒƒãƒ‰ãƒ¬ã‚¹ãƒ¢ãƒ¼ãƒ‰\n\nç”Ÿæˆå†…å®¹:\n  âœ… å¯è¦–è¦ç´ ãƒ†ã‚¹ãƒˆ - ç”»é¢è¡¨ç¤ºè¦ç´ ã‚’åº§æ¨™é †ã«å®Œå…¨è§£æ\n  âœ… ãƒ•ã‚©ãƒ¼ãƒ ãƒ†ã‚¹ãƒˆ - ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼è§£æã§æœ€é©ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ\n  âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆ - XSS/SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ç­‰ï¼ˆå…¥åŠ›â†’é€ä¿¡â†’æœªç™ºç«ç¢ºèªï¼‰\n  âœ… ãƒªãƒ³ã‚¯/ã‚»ãƒ¬ã‚¯ãƒˆ/æ¤œç´¢ - ä¸è¶³æ‰‹é †ã¯è‡ªå‹•è£œå®Œ\n  ğŸ›’ EC-CUBEæ¤œå‡º - EC-CUBEã‚µã‚¤ãƒˆã¯è‡ªå‹•æ¤œå‡ºã—ã¦å°‚ç”¨è§£æ\n\nğŸ’¡ æ¨å¥¨: æœ€é€Ÿã§åŒ…æ‹¬çš„ãªãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’ä½œæˆã§ãã¾ã™')
  .option('--url <url>', 'è§£æã™ã‚‹ãƒšãƒ¼ã‚¸ã®URL')
  .option('--browser <type>', 'ãƒ–ãƒ©ã‚¦ã‚¶é¸æŠ (chromium|firefox|webkit)', 'chromium')
  .option('--headless', 'ãƒ˜ãƒƒãƒ‰ãƒ¬ã‚¹ãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œ')
  .option('--cli <type>', 'AI CLIé¸æŠ (gemini|claude|auto)', 'auto')
  .action(async (options) => {
    const autoGenerator = new TestCaseAutoGenerator(options);
    if (options.url) {
      // URLæŒ‡å®šã®å ´åˆã¯ç›´æ¥è§£æ
      const analysis = await autoGenerator.analyzePageWithAI(options.url);
      console.log(`\nâœ… ${analysis.testSuggestions.length}å€‹ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’ç”Ÿæˆã—ã¾ã—ãŸ`);
      
      // è‡ªå‹•ä¿å­˜
      const saved = await autoGenerator.saveGeneratedTestCases(analysis.testSuggestions);
      console.log(`ğŸ“ ä¿å­˜å®Œäº†: ${saved.map(tc => tc.test_id).join(', ')}`);
    } else {
      // å¯¾è©±å¼ãƒ¢ãƒ¼ãƒ‰
      await autoGenerator.interactiveAutoGenerate();
    }
  });

program
  .command('optimize')
  .alias('opt')
  .description('ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’AI CLIã§ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»æœ€é©åŒ–\n\nä½¿ç”¨ä¾‹:\n  ./web-test optimize          # å¯¾è©±å‹ã§æœ€é©åŒ–ãƒ¢ãƒ¼ãƒ‰é¸æŠ\n  ./web-test opt              # ã‚¨ã‚¤ãƒªã‚¢ã‚¹ä½¿ç”¨\n  ./web-test optimize --mode auto --auto-save  # è‡ªå‹•æœ€é©åŒ–ã‚’å³å®Ÿè¡Œ\n\næœ€é©åŒ–ãƒ¢ãƒ¼ãƒ‰:\n  ğŸš€ è‡ªå‹•æœ€é©åŒ– - é‡è¤‡å‰Šé™¤ã€å„ªå…ˆåº¦èª¿æ•´ã€ã‚«ãƒ†ã‚´ãƒªæ•´ç† + ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æ”¹å–„\n  ğŸ“Š ã‚«ãƒ†ã‚´ãƒªåˆ¥ - ç‰¹å®šã‚«ãƒ†ã‚´ãƒªã®ã¿æœ€é©åŒ–\n  ğŸ¯ å„ªå…ˆåº¦åˆ¥ - å„ªå…ˆåº¦ã‚’å†è©•ä¾¡\n  ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆã®é‡è¤‡å‰Šé™¤\n  ğŸ—‘ï¸ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ— - ç„¡åŠ¹ãƒ»é‡è¤‡ãƒ†ã‚¹ãƒˆå‰Šé™¤ + ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æ”¹å–„\n  âœ¨ å®Œå…¨ãƒ¬ãƒ“ãƒ¥ãƒ¼ - AI CLIã§å…¨ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’è©³ç´°ãƒ¬ãƒ“ãƒ¥ãƒ¼\n\nãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æ”¹å–„ (auto/cleanupãƒ¢ãƒ¼ãƒ‰):\n  â€¢ æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: å±±ç”°å¤ªéƒ â†’ ã‚¸ã‚§ãƒ©ãƒ¼ãƒˆï¼ˆECã‚µã‚¤ãƒˆï¼‰\n  â€¢ ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±: é©åˆ‡ãªãƒ¡ãƒ¼ãƒ«ãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã«å¤‰æ›´\n  â€¢ ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ : å®Ÿåœ¨å½¢å¼ã®ä½æ‰€ãƒ»é›»è©±ç•ªå·ã«å¤‰æ›´\n  â€¢ ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹åãƒ»æœŸå¾…çµæœã‚‚åŒæ™‚æ›´æ–°')
  .option('--mode <mode>', 'æœ€é©åŒ–ãƒ¢ãƒ¼ãƒ‰ (auto|category|priority|security|cleanup|full)', 'auto')
  .option('--cli <type>', 'AI CLIé¸æŠ (gemini|claude|auto)', 'auto')
  .option('--auto-save', 'æœ€é©åŒ–å¾Œã«è‡ªå‹•çš„ã«ä¿å­˜ (ç¢ºèªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—)')
  .action(async (options) => {
    const optimizer = new TestCaseOptimizer(options);
    await optimizer.reviewAndOptimize();
  });

program
  .command('init')
  .description('WebTestAIã‚’åˆæœŸåŒ–ã—ã€CLIå›ºæœ‰ã®ä»•æ§˜æ›¸ã‚’èª­ã¿è¾¼ã¿ã¾ã™\n\nå‹•ä½œ:\n  1. ç¾åœ¨ã®CLIç’°å¢ƒã‚’æ¤œå‡ºï¼ˆGemini/Claudeï¼‰\n  2. å¯¾å¿œã™ã‚‹ä»•æ§˜æ›¸ã‚’èª­ã¿è¾¼ã¿ï¼ˆGEMINI.md/claude.mdï¼‰\n  3. ã‚·ã‚¹ãƒ†ãƒ ä»•æ§˜ã‚’ç†è§£ã—ã¦åˆæœŸè¨­å®šã‚’å®Ÿè¡Œ\n\nä½¿ç”¨ä¾‹:\n  ./web-test init              # è‡ªå‹•æ¤œå‡ºã—ã¦åˆæœŸåŒ–\n  ./web-test init --cli gemini # Gemini CLIç”¨ã«åˆæœŸåŒ–\n  ./web-test init --cli claude # Claude CLIç”¨ã«åˆæœŸåŒ–')
  .option('--cli <type>', 'CLIæŒ‡å®š (gemini|claude|auto)', 'auto')
  .action(async (options) => {
    const fs = await import('fs/promises');
    const path = await import('path');
    const chalk = (await import('chalk')).default;
    
    console.log(chalk.cyan('\nğŸš€ WebTestAI åˆæœŸåŒ–é–‹å§‹\n'));
    
    // CLIæ¤œå‡º
    let detectedCli = options.cli;
    if (detectedCli === 'auto') {
      const { execSync } = await import('child_process');
      
      try {
        execSync('which gemini', { stdio: 'ignore' });
        detectedCli = 'gemini';
        console.log(chalk.green('âœ… Gemini CLI ã‚’æ¤œå‡ºã—ã¾ã—ãŸ'));
      } catch {}
      
      try {
        execSync('which claude', { stdio: 'ignore' });
        if (detectedCli === 'gemini') {
          console.log(chalk.green('âœ… Claude Code CLI ã‚‚æ¤œå‡ºã—ã¾ã—ãŸ'));
        } else {
          detectedCli = 'claude';
          console.log(chalk.green('âœ… Claude Code CLI ã‚’æ¤œå‡ºã—ã¾ã—ãŸ'));
        }
      } catch {}
      
      if (!detectedCli || detectedCli === 'auto') {
        console.log(chalk.yellow('âš ï¸  AI CLIãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æ‰‹å‹•ã§æŒ‡å®šã—ã¦ãã ã•ã„ã€‚'));
        detectedCli = 'gemini'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
      }
    }
    
    // ä»•æ§˜æ›¸èª­ã¿è¾¼ã¿
    const specFile = detectedCli === 'claude' ? 'claude.md' : 'GEMINI.md';
    const specPath = path.join(process.cwd(), specFile);
    
    try {
      const specContent = await fs.readFile(specPath, 'utf-8');
      console.log(chalk.blue(`\nğŸ“– ${specFile} ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`));
      console.log(chalk.gray('   ã‚·ã‚¹ãƒ†ãƒ ä»•æ§˜ã‚’ç†è§£ã—ã¦ã„ã¾ã™...\n'));
      
      // ä»•æ§˜æ›¸ã®ä¸»è¦ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
      const lines = specContent.split('\n');
      const sections = lines.filter(line => line.startsWith('## ')).slice(0, 5);
      console.log(chalk.white('èª­ã¿è¾¼ã‚“ã ä»•æ§˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³:'));
      sections.forEach(section => {
        console.log(chalk.gray(`   ${section.replace('## ', 'â€¢ ')}`));
      });
      
      console.log(chalk.green(`\nâœ… ${detectedCli === 'claude' ? 'Claude Code' : 'Gemini'} CLIç”¨ã®åˆæœŸåŒ–ãŒå®Œäº†ã—ã¾ã—ãŸ`));
      console.log(chalk.cyan('\nğŸ“ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:'));
      console.log('   1. ./init.sh ã‚’å®Ÿè¡Œã—ã¦ç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—');
      console.log('   2. ./web-test auto ã§ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’è‡ªå‹•ç”Ÿæˆ');
      console.log('   3. ./web-test run ã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ\n');
      
    } catch (error) {
      console.log(chalk.red(`âŒ ${specFile} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`));
      console.log(chalk.yellow('   ä»•æ§˜æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„\n'));
    }
  });

program.parse(process.argv);
